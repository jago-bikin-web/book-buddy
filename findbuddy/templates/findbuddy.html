{% extends 'base.html' %}

{% load static %}

{% block framework %}
  <script src="https://cdn.tailwindcss.com"></script>
{% endblock %}

{% block meta %}
<title>Books Buddy</title>
<link rel="stylesheet" href="{% static 'css/findbuddy.css' %}" type="text/css"/>
{% endblock %}

{% block content %}

{% include 'header.html' %}

<div class="search-bar">
    <input type="text" id="search-input" class="search-input" placeholder="Search books...">
</div>

<div class="filter-container" id="filter-container">

    <div class="filter-dropdown">
        <label for="category-filter">Filter by Category:</label>
        <select id="category-filter">
            <option value="">All Categories</option>
            <!-- Loop through categories and add options dynamically -->
            {% for category in categories %}
                <option value="{{ category }}">{{ category }}</option>
            {% endfor %}
        </select>
    </div>
</div>

<div id="product_cards" class="custom-card"></div>

<div id="pagination" class="pagination-container"></div>

<button id="request-button" class="button-req">REQUEST BOOK</button>

<form method="post" id="book-form">
    {% csrf_token %}
    {{ form.as_table }}
    <button type="submit" id="button_add">Submit</button>
</form>


<table id="form_table" class="table table-bordered table-striped">
    <thead>
        <tr>
            <th style="white-space: nowrap; background-color:lightblue">Title</th>
            <th style="white-space: nowrap; background-color:lightblue">Authors</th>
        </tr>
    </thead>
</table>


<div class="modal" id="productModal">
    <div class="modal-content" id="modalContent">
        <button class="close">Close</button>
        <div class="modal-flex-container">
            <img class="modal-image" id="modalImage" src="" alt="Large Book Cover">
            <div class="modal-details">
                <h2 id="modalTitle"></h2>
                <p><strong>Author:</strong> <span id="modalAuthor"></span></p>
                <p><strong>Publisher:</strong> <span id="modalPublisher"></span></p>
                <p><strong>Published Date:</strong> <span id="modalPublishedDate"></span></p>
                <p><strong>Page Count:</strong> <span id="modalPageCount"></span></p>
                <p><strong>Categories:</strong> <span id="modalCategories"></span></p>
                <p><strong>Ratings:</strong> <span id="modalAverageRating"></span></p>
                <p><strong>Language:</strong> <span id="modalLanguage"></span></p>
                <p><strong>Buy Link:</strong> <a href="" id="modalBuyLink" target="_blank">Buy Now</a></p>
                <p class="modal-description" id="modalDescription"></p>
                <!-- <form id="form" method="dialog">
                    {% csrf_token %}
                    {{ form.as_table }}
                    <button type="submit" id="buttonSubmit">Submit</button>
                </form> -->
            </div>
        </div>
    </div>
</div>


<script>
    const cardsPerPage = 15;
    let currentPage = 1;
    let products = [];
    let initialProducts = [];
    
    const searchInput = document.getElementById("search-input");
    
    searchInput.addEventListener("input", () => {
        const searchTerm = searchInput.value.toLowerCase();
        const searchResults = initialProducts.filter(product => product.fields.title.toLowerCase().startsWith(searchTerm));
        currentPage = 1;
        renderFilteredProducts(searchResults);
    });
    
    async function getProducts() {
        return fetch("{% url 'findbuddy:get_book_json' %}")
            .then((res) => res.json());
    }

    function openModal(product) {
        const modal = document.getElementById("productModal");
        const modalImage = document.getElementById("modalImage");
        const modalTitle = document.getElementById("modalTitle");
        const modalAuthor = document.getElementById("modalAuthor");
        const modalDescription = document.getElementById("modalDescription");
        const modalPublisher = document.getElementById("modalPublisher");
        const modalPublishedDate = document.getElementById("modalPublishedDate");
        const modalPageCount = document.getElementById("modalPageCount");
        const modalCategories = document.getElementById("modalCategories");
        const modalAverageRating = document.getElementById("modalAverageRating");
        const modalLanguage = document.getElementById("modalLanguage");
        const modalBuyLink = document.getElementById("modalBuyLink");

        const closeModalBtn = document.querySelector(".close");

        modal.style.display = "block";
        modalImage.src = product.fields.thumbnail;
        modalImage.alt = product.fields.title;
        modalTitle.textContent = product.fields.title;
        modalAuthor.textContent = product.fields.authors;
        modalDescription.textContent = product.fields.description;
        modalPublisher.textContent = product.fields.publisher;
        modalPublishedDate.textContent = product.fields.published_date;
        modalPageCount.textContent = product.fields.page_count;
        modalCategories.textContent = product.fields.categories;
        modalAverageRating.textContent = product.fields.average_rating;
        modalLanguage.textContent = product.fields.languange;
        modalBuyLink.href = product.fields.buyLink;

        if (product.fields.average_ratings) {
            modalAverageRatings.textContent = product.fields.average_ratings;
        } else {
            modalAverageRating.textContent = "None";
        }

        closeModalBtn.addEventListener("click", () => {
            modal.style.display = "none";
        });

        buttonSubmit.addEventListener("click", () => {
            addRating
            alert("wooi -1")
        })
    }


    async function updateProductsByCategory(category) {
        const selectedCategory = category;
        if (selectedCategory) {
            const newProducts = initialProducts.filter(product => product.fields.categories === selectedCategory);
            currentPage = 1;
            renderFilteredProducts(newProducts);
        } else {
            currentPage = 1;
            renderFilteredProducts(initialProducts);
        }
    }
    
    function renderFilteredProducts(filteredProducts) {
        products = filteredProducts;
        renderCurrentPage();
        renderPagination();
    }
    
    function renderCurrentPage() {
        const cardContainer = document.getElementById("product_cards");
        cardContainer.innerHTML = "";
    
        const startIndex = (currentPage - 1) * cardsPerPage;
        const endIndex = startIndex + cardsPerPage;

        for (let i = startIndex; i < endIndex && i < products.length; i++) {
            const item = products[i];
            const authors = item.fields.authors.split(",");

            const card = document.createElement("div");
            card.className = "product-card";
            card.id = `product-card-${i}`; // Tambahkan id ke kartu

            card.innerHTML = `
                <img class="product-image" src="${item.fields.small_thumbnail}" alt="Book Cover">
                <div>
                    <p>${item.fields.title}</p>
                    <p><strong>Author:</strong> ${formatAuthors(authors)}</p>
                    <p><strong>Description:</strong> ${truncateDescription(item.fields.description, 10)}</p>
                </div>
            `;
            cardContainer.appendChild(card);
            card.addEventListener("click", () => openModal(item)); // Tambahkan event listener
        }
    }
    
    function formatAuthors(authors) {
        if (authors.length === 1) {
            return authors[0];
        } else {
            return authors[0] + ", and more";
        }
    }
    
    function truncateDescription(description, wordCount) {
        const words = description.split(" ");
        if (words.length > wordCount) {
            return words.slice(0, wordCount).join(" ") + " ...";
        }
        return description;
    }
    
    function renderPagination() {
        const paginationContainer = document.getElementById("pagination");
        paginationContainer.innerHTML = "";
    
        const totalPages = Math.ceil(products.length / cardsPerPage);
    
        const pageBar = document.createElement("div");
        pageBar.className = "page-bar";
    
        if (currentPage > 1) {
            const prevButton = document.createElement("button");
            prevButton.className = "pagination-button";
            prevButton.innerText = "Previous";
            prevButton.addEventListener("click", () => {
                currentPage--;
                renderCurrentPage();
                scrollToTop();
                renderPagination();
            });
            pageBar.appendChild(prevButton);
        }
    
        const pageBarText = document.createElement("div");
        pageBarText.className = "page-bar-text";
        pageBarText.innerText = `Page ${currentPage} of ${totalPages}`;
        pageBar.appendChild(pageBarText);
    
        if (currentPage < totalPages) {
            const nextButton = document.createElement("button");
            nextButton.className = "pagination-button";
            nextButton.innerText = "Next";
            nextButton.addEventListener("click", () => {
                currentPage++;
                renderCurrentPage();
                scrollToTop();
                renderPagination();
            });
            pageBar.appendChild(nextButton);
        }
    
        paginationContainer.appendChild(pageBar);
    }
    
    function scrollToTop() {
        window.scrollTo(0, 0);
    }
    
    const categoryFilter = document.getElementById("category-filter");
    
    categoryFilter.addEventListener("change", () => {
        updateProductsByCategory(categoryFilter.value);
    });
    
    const filterContainer = document.getElementById("filter-container");
    
    getProducts().then((data) => {
        products = data;
        initialProducts = data;
        renderCurrentPage();
        renderPagination();
    });

    document.addEventListener("DOMContentLoaded", function() {
        const requestButton = document.getElementById("request-button");
        const bookForm = document.getElementById("book-form");

        requestButton.addEventListener("click", function() {
            bookForm.style.display = "block"; // Menampilkan formulir ketika tombol ditekan
        });
    });

    function addRequest() {
        fetch("{% url 'findbuddy:add_request_ajax' %}", {
            method: "POST",
            body: new FormData(document.querySelector('#form'))
        }).then(refreshProducts)

        document.getElementById("form").reset()
        return false
    }

    document.getElementById("button_add").onclick = addRequest();

    async function getRequest() {
        return fetch("{% url 'findbuddy:get_request_json' %}").then((res) => res.json())
        }

        async function refreshRequest() {
            const products = await getRequest();

        itemCountElement.textContent = products.length;
            let htmlString = `<table id="product_table" class="table table-bordered table-striped">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Author</th>
                    </tr>
                </thead>
                <tbody>`;
                    
            
        products.forEach((item) => {
            htmlString += `
                <tr>
                    <td>${item.fields.title}</td>
                    <td>${item.fields.author}</td>
                </tr>`;
        });

        htmlString += `</tbody></table>`;
    }

    refreshRequest();
</script>

{% include 'footer.html' %}


{% endblock content %}