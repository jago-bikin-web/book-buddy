{% extends 'base.html' %}

{% block framework %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
{% endblock framework %}

{% block content %}
<style>
    .custom-card {
        width: 90%;
        margin: 20px auto;
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
    }

    .product-card {
        width: calc(30% - 20px);
        background-color: #e6e6e6;
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
        display: flex;
        align-items: center;
    }

    .product-image {
        width: 100px;
        height: 150px;
        margin-right: 10px;
    }

    .pagination-container {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 20px;
    }

    .page-link {
        cursor: pointer;
        padding: 5px 10px;
        margin: 0 5px;
    }

    .pagination-button {
        cursor: pointer;
        background-color: #007bff;
        color: #fff;
        border: none;
        border-radius: 5px;
        padding: 5px 10px;
        margin: 0 5px;
    }

    .page-bar {
        display: flex;
        align-items: center;
    }

    .page-bar-text {
        margin: 0 10px;
    }

    /* Style for filters */
    .filter-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-start;
        margin-top: 10px;
    }

    .filter-dropdown {
        margin-right: 10px;
    }
</style>

<div class="filter-container" id="filter-container">

    <div class="filter-dropdown">
        <label for="category-filter">Filter by Category:</label>
        <select id="category-filter">
            <option value="">All Categories</option>
            <!-- Loop through categories and add options dynamically -->
            {% for category in categories %}
                <option value="{{ category }}">{{ category }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="filter-dropdown">
        <label for="rating-filter">Filter by Rating:</label>
        <select id="rating-filter">
            <option value="">All Ratings</option>
            <option value="1">1 Star</option>
            <option value="2">2 Stars</option>
            <option value="3">3 Stars</option>
            <option value="4">4 Stars</option>
            <option value="5">5 Stars</option>
        </select>
    </div>
    <button id="filter-button" class="show-filters-button">Filter</button>
</div>

<div id="product_cards" class="custom-card"></div>

<div id="pagination" class="pagination-container"></div>

<script>
    const cardsPerPage = 15;
    let currentPage = 1;
    let products = [];

    async function getProducts() {
        return fetch("{% url 'findbuddy:get_book_json' %}")
            .then((res) => res.json());
    }

    function renderCurrentPage() {
        const cardContainer = document.getElementById("product_cards");
        cardContainer.innerHTML = "";

        const startIndex = (currentPage - 1) * cardsPerPage;
        const endIndex = startIndex + cardsPerPage;

        for (let i = startIndex; i < endIndex && i < products.length; i++) {
            const item = products[i];
            const authors = item.fields.authors.split(",");

            const card = document.createElement("div");
            card.className = "product-card";

            card.innerHTML = `
                <img class="product-image" src="${item.fields.small_thumbnail}" alt="Book Cover">
                <div>
                    <p>${item.fields.title}</p>
                    <p><strong>Author:</strong> ${formatAuthors(authors)}</p>
                    <p><strong>Description:</strong> ${truncateDescription(item.fields.description, 10)}</p>
                </div>
            `;
            cardContainer.appendChild(card);
        }
    }

    function formatAuthors(authors) {
        if (authors.length === 1) {
            return authors[0];
        } else {
            return authors[0] + ", and more";
        }
    }

    function truncateDescription(description, wordCount) {
        const words = description.split(" ");
        if (words.length > wordCount) {
            return words.slice(0, wordCount).join(" ") + " ...";
        }
        return description;
    }

    function renderPagination() {
        const paginationContainer = document.getElementById("pagination");
        paginationContainer.innerHTML = "";

        const totalPages = Math.ceil(products.length / cardsPerPage);

        const pageBar = document.createElement("div");
        pageBar.className = "page-bar";

        if (currentPage > 1) {
            const prevButton = document.createElement("button");
            prevButton.className = "pagination-button";
            prevButton.innerText = "Previous";
            prevButton.addEventListener("click", () => {
                currentPage--;
                renderCurrentPage();
                scrollToTop();
                renderPagination();
            });
            pageBar.appendChild(prevButton);
        }

        const pageBarText = document.createElement("div");
        pageBarText.className = "page-bar-text";
        pageBarText.innerText = `Page ${currentPage} of ${totalPages}`;
        pageBar.appendChild(pageBarText);

        if (currentPage < totalPages) {
            const nextButton = document.createElement("button");
            nextButton.className = "pagination-button";
            nextButton.innerText = "Next";
            nextButton.addEventListener("click", () => {
                currentPage++;
                renderCurrentPage();
                scrollToTop();
                renderPagination();
            });
            pageBar.appendChild(nextButton);
        }

        paginationContainer.appendChild(pageBar);
    }

    function scrollToTop() {
        window.scrollTo(0, 0);
    }
    

    function applyFilters() {
        const selectedCategory = document.getElementById("category-filter").value;
        const selectedRating = document.getElementById("rating-filter").value;

        // Filter products based on selected filters
        let filteredProducts = products;

        if (selectedCategory) {
            filteredProducts = filteredProducts.filter(product => product.fields.categories === selectedCategory);
        }

        if (selectedRating) {
            const selectedRatingValue = parseInt(selectedRating);
            filteredProducts = filteredProducts.filter(product => Math.floor(product.fields.average_rating) === selectedRatingValue);
        }

        // Update products and reset currentPage to 1
        products = filteredProducts;
        currentPage = 1;

        // Render the updated page and pagination
        renderCurrentPage();
        renderPagination();
    }

    // Function to fetch products based on category
    async function updateProductsByCategory() {
        const selectedCategory = document.getElementById("category-filter").value;
        if (selectedCategory) {
            const newProducts = await getProductsByCategory(selectedCategory);
            products = newProducts;
            currentPage = 1;
            renderCurrentPage();
            renderPagination();
        }
    }

    async function getProductsByCategory(category) {
        try {
            const response = await fetch(`{% url 'findbuddy:get_book_json' %}?category=${category}`);
            if (response.ok) {
                const newProducts = await response.json();
                return newProducts;
            } else {
                console.error("Failed to fetch products by category.");
            }
        } catch (error) {
            console.error("An error occurred while fetching products:", error);
        }
    }

    // function applyFilters() {
    //     const selectedRating = document.getElementById("rating-filter").value;

    //     // Filter products based on selected rating
    //     let filteredProducts = products;

    //     if (selectedRating) {
    //         const selectedRatingValue = parseInt(selectedRating);
    //         filteredProducts = filteredProducts.filter(product => Math.floor(product.fields.average_rating) === selectedRatingValue);
    //     }

    //     // Update products and reset currentPage to 1
    //     products = filteredProducts;
    //     currentPage = 1;

    //     renderCurrentPage();
    //     renderPagination();
    // }



    // function applyFilters() {
    //     const categoryFilter = document.getElementById("category-filter").value;
    //     const ratingFilter = document.getElementById("rating-filter").value;

    //     // Filter products based on category and rating
    //     const filteredProducts = products.filter((product) => {
    //         if (categoryFilter && product.fields.categories !== categoryFilter) {
    //             return false;
    //         }

    //         if (ratingFilter) {
    //             const selectedRating = parseInt(ratingFilter);
    //             const productRating = Math.floor(product.fields.average_rating);
    //             if (selectedRating !== productRating) {
    //                 return false;
    //             }
    //         }

    //         return true;
    //     });

    //     // Update products and reset currentPage to 1
    //     products = filteredProducts;
    //     currentPage = 1;

    //     // Render the updated page and pagination
    //     renderCurrentPage();
    //     renderPagination();
    // }

    document.getElementById("category-filter").addEventListener("change", updateProductsByCategory);
    document.getElementById("rating-filter").addEventListener("change", applyFilters);

    const filterButton = document.getElementById("filter-button");
    filterButton.addEventListener("click", () => {
        applyFilters();
    });

    const filterContainer = document.getElementById("filter-container");

    getProducts().then((data) => {
        products = data;
        renderCurrentPage();
        renderPagination();
    });
</script>
{% endblock content %}